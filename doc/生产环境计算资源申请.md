## 生产环境计算资源申请

### 邮件模板



注意: 因为框架仍处于快速迭代期间，请每次申请资源前都看一遍此文档，可能会新增不少选项

收件人: yangxingping@bigo.sg, honghaoqiang@bigo.sg, duguiping@bigo.sg, sunxu@bigo.sg

抄送: 对应的业务负责人/直属leader

邮件标题: [集群计算资源申请]业务名-模型名-机器数量

|                                             |                                                              |
| ------------------------------------------- | ------------------------------------------------------------ |
| 机器数目 *                                  | 40                                                           |
| 服务名 *                                    | like-core                                                    |
| 业务名 *                                    | like                                                         |
| 资源池名称 *                                | bigolive-cv                                                  |
| 进程负责人 *                                | 阳兴平，洪浩强                                               |
| CPU(单replica，单位T; 普通机器配置16C32T) * | 10                                                           |
| Memory(单replica) *                         | 80GB                                                         |
| 最高QPS(单replica) *                        | 8                                                            |
| 显存占用(单replica) *                       | 8GB                                                          |
| 平均显卡利用率(2080Ti/T4) *                 | 70%                                                          |
| 平均QPS/高峰期QPS(总流量) *                 | 200/300                                                      |
| Git URL *                                   | https://git.sysop.bigo.sg/infer-serving/brpc-deploy/tree/like_core |
| 流量来源 *                                  | like短视频实时流                                             |
| 增速预估                                    | 与like日活数正相关                                           |
| 结果用途                                    | like人审、视频直接封禁                                       |
| 流量来源负责人                              | 阳兴平                                                       |
| 成功率告警阈值                              | 99%                                                          |
| restart告警阈值                             | 5min, 2                                                      |
| 备注                                        | like 核心模型包，包含6个子模型；跟随文件存储全球部署，HK，EU，AM三个大区机器比例3:2:1； |



### 字段介绍

- 服务名

  即value.py中的service_name, 等同于k8s中的deployment name

- 业务名

  like/imo/bigolive/hello/...

- 进程负责人

  此程序/模型的直接责任人，至少一人

- 资源池名称
  
  每个team/业务线 拥有各自的资源池，用于各业务的资源隔离和成本核算，也可增加部署的灵活性

- CPU

  单个replicas最多占用的CPU线程数

  参见[程序效率评估](./程序效率评估.md)

  后续计划引入cpu affinity策略

- Memory

  参见[程序效率评估](./程序效率评估.md)

  inference机器一般单机内存为128GB，考虑到有一些系统服务程序会占用少许内存。程序使用内存量超过此限制会OOM，被操作系统kill掉，然后重启

- 最高QPS

  参见[程序效率评估](./程序效率评估.md)

  自己启动一个Client，用尽全力去发送请求。看最高QPS能够达到多少

- 显存占用

  参见[程序效率评估](./程序效率评估.md)

  单卡显存占用，一般情况下，每张显卡显存占用不会差距太大

  如无特殊情况，请使用tf的时候拒绝`allow_growth=false`

- 平均显卡利用率

  参见[程序效率评估](./程序效率评估.md)

  最高QPS的情况下，平均显卡利用率

- 平均QPS/最高QPS

  这个就和业务强相关了，如果没有每秒的经验数值，可以根据每天的总请求来进行估算，常见的公式为 request_totol_per_day / 86400 * 2

  例如likee每天1.5kw新增视频，公式得出最高QPS为346，略高于300的最高QPS

- Git URL

  git源码地址

- 流量来源

  例如live直播截图，imo群聊，imo贴吧，like高vv等等

- 增速预估

  预估需要资源的增加速率

- 结果用途

  程序的实际应用

- 流量来源负责人

  主要是告诉我们，如果这个数据源出故障了，没有请求了，我们应该去找谁

- 成功率告警阈值

  当请求成功率低于阈值的时候，会发送企业微信告警

- restart告警阈值

  当程序在一段时间内，连续restart了多少次，将会发送企业微信告警
